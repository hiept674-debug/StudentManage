<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Quản lý sinh viên</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="container mt-4">
    <h3>DANH SÁCH SINH VIÊN</h3>

    <input
      type="text"
      id="search"
      class="form-control mb-3"
      placeholder="Tìm theo tên..."
      onkeyup="searchStudent()"
    />

    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Tên</th>
          <th>Email</th>
          <th style="width: 150px">Hành động</th>
        </tr>
      </thead>
      <tbody id="studentTable"></tbody>
    </table>

    <hr />

    <h4>Thông tin sinh viên</h4>
    <div class="card p-3 bg-light">
      <div class="mb-2">
        <label>Mã SV:</label>
        <input id="id" class="form-control" placeholder="Nhập ID" />
      </div>

      <div class="mb-2">
        <label>Họ tên:</label>
        <input id="name" class="form-control" placeholder="Nhập Tên" />
      </div>

      <div class="mb-2">
        <label>Email:</label>
        <input id="email" class="form-control" placeholder="Nhập Email" />
      </div>

      <div class="mt-3">
        <button id="btnAdd" class="btn btn-primary" onclick="addStudent()">
          Thêm mới
        </button>
        <button
          id="btnUpdate"
          class="btn btn-warning"
          onclick="updateStudent()"
          style="display: none"
        >
          Lưu thay đổi
        </button>
        <button
          id="btnCancel"
          class="btn btn-secondary"
          onclick="resetForm()"
          style="display: none"
        >
          Hủy
        </button>
      </div>
    </div>

    <script>
      const API = "http://localhost:8090/api/students";

      // 1. Load danh sách sinh viên
      function loadStudents() {
        fetch(API)
          .then((res) => res.json())
          .then((data) => renderTable(data))
          .catch((err) => console.error("Lỗi load:", err));
      }

      // Hàm render bảng (tách ra để dùng chung cho cả Search)
      function renderTable(data) {
        let html = "";
        data.forEach((s) => {
          // LƯU Ý: Thêm dấu nháy đơn vào '${s.id}' để sửa lỗi xóa
          html += `
            <tr>
                <td>${s.id}</td>
                <td>${s.name}</td>
                <td>${s.email}</td>
                <td>
                    <button class="btn btn-info btn-sm"
                        onclick="editStudent('${s.id}', '${s.name}', '${s.email}')">Sửa</button>
                    <button class="btn btn-danger btn-sm"
                        onclick="deleteStudent('${s.id}')">Xóa</button>
                </td>
            </tr>`;
        });
        document.getElementById("studentTable").innerHTML = html;
      }

      // 2. Thêm sinh viên
      function addStudent() {
        const student = {
          name: document.getElementById("name").value,
          email: document.getElementById("email").value,
        };

        if (!student.name || !student.email) {
          return alert("Vui lòng nhập đầy đủ thông tin!");
        }

        fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(student),
        })
          .then((res) => {
            if (!res.ok) throw new Error("Lỗi thêm sinh viên");
            return res.json();
          })
          .then(() => {
            loadStudents();
            resetForm();
            alert("Thêm thành công!");
          })
          .catch((err) => alert(err.message));
      }

      // 4. Chuẩn bị dữ liệu để Sửa (Đưa dữ liệu lên form)
      function editStudent(id, name, email) {
        document.getElementById("id").value = id;
        document.getElementById("name").value = name;
        document.getElementById("email").value = email;

        // Khóa ô ID lại (thường ID là khóa chính, không nên sửa)
        document.getElementById("id").disabled = true;

        // Đổi nút bấm
        document.getElementById("btnAdd").style.display = "none";
        document.getElementById("btnUpdate").style.display = "inline-block";
        document.getElementById("btnCancel").style.display = "inline-block";
      }

      // 5. Thực hiện Update (Gửi PUT request)
      function updateStudent() {
        const id = document.getElementById("id").value;
        const student = {
          name: document.getElementById("name").value,
          email: document.getElementById("email").value,
        };

        fetch(`${API}/update/${id}`, {
          method: "POST", // ⚠️ PHẢI là POST
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(student),
        })
          .then((res) => {
            if (!res.ok) throw new Error("Cập nhật thất bại");
            return res.json();
          })
          .then(() => {
            loadStudents();
            resetForm();
            alert("Cập nhật thành công!");
          })
          .catch((err) => alert(err.message));
      }

      // 6. Tìm kiếm
      function searchStudent() {
        const name = document.getElementById("search").value;
        if (!name) {
          loadStudents();
          return;
        }
        fetch(`${API}/search?name=${name}`)
          .then((res) => res.json())
          .then((data) => renderTable(data));
      }

      // 7. Reset form về trạng thái ban đầu
      function resetForm() {
        document.getElementById("id").value = "";
        document.getElementById("name").value = "";
        document.getElementById("email").value = "";
        document.getElementById("id").disabled = false; // Mở khóa ô ID
        document.getElementById("btnAdd").style.display = "inline-block";
        document.getElementById("btnUpdate").style.display = "none";
        document.getElementById("btnCancel").style.display = "none";
      }

      // Chạy lần đầu
      loadStudents();
    </script>
  </body>
</html>
